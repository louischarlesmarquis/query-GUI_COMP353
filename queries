DELIMITER $$

CREATE TRIGGER CheckEmployeeScheduleConflict
BEFORE INSERT OR UPDATE ON Schedule
FOR EACH ROW
BEGIN
    -- Check for time conflict at any facility
    IF EXISTS (
        SELECT 1
        FROM Schedule AS S
        WHERE S.employee_id = NEW.employee_id
          AND S.date = NEW.date
          AND (
            (NEW.start_time < S.end_time AND NEW.end_time > S.start_time)
            OR
            (NEW.end_time > S.start_time AND NEW.start_time < S.end_time)
          )
          AND NEW.start_time < S.end_time - INTERVAL 2 HOUR
          AND NEW.end_time > S.start_time + INTERVAL 2 HOUR
          AND S.id <> NEW.id -- Assuming there is a unique identifier 'id' for schedule entries
    ) THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'An employee cannot be scheduled for conflicting times.';
    END IF;
END;
$$

DELIMITER ;
